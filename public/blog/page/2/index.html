
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>Christopher Agocs  | Agocs</title>

<meta name="author" content="Christopher Agocs"> 

<meta name="description" content="Sometimes I blog stuff"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Agocs" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Agocs</a></h1>
<h4>Christopher Agocs</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/social-media">Contact + Social Media</a></li>
	<li><a href="/resume">Resume</a></li>
	<li><a href="/projects">Projects</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/robotfindskitten/non-kitten-item/">Robot Finds Kitten</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/social-media">Contact + Social Media</a></li>
	<li><a href="/resume">Resume</a></li>
	<li><a href="/projects">Projects</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/robotfindskitten/non-kitten-item/">Robot Finds Kitten</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:agocs.org">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/09/19/agox-connectors/">
		
			AGOX Connectors</a>
	</h2>
	<div class="entry-content">
		<h3>Or, how we hacked reality</h3>

<p>This is an eight-pin AGOX connector:</p>

<p><img src="http://i.imgur.com/NHrH5hOl.jpg"></p>

<p>In September of 2008, I was a student at the <a href="http://www.gatech.edu">North Avenue Trade School</a> and heavily involved in the <a href="http://www.wrek.org">WREK</a> radio station. One of my good friends at the time was <a href="http://centrisian.com/">Robert Wright</a>. My &ldquo;initials&rdquo; (how we logged in, signed up for shifts, etc.) at the radio station were &ldquo;AGOX&rdquo;, and I signed all my emails that way. One afternoon, Robert pointed me toward the Wikipedia Talk page for USB: specifically at a section called <a href="http://en.wikipedia.org/wiki/Talk:USB/Archive_4#Mystery_micro_plug">Mystery Micro Plug</a>. At the bottom, he wrote:</p>

<blockquote><p>Based on personal knowledge, and having worked in the field for a few years, the &lsquo;Mystery Plug&rsquo; is internally named the &lsquo;Agox connector&rsquo; when used in combination with digital cameras. We refer to them this way because of the gentleman with whom I worked. 128.61.120.190 (talk) 22:49, 23 September 2008 (UTC)</p></blockquote>

<p>I thought it was funny, so I replied.</p>

<blockquote><p>I think I remember seeing it called the &lsquo;Agox Connector&rsquo; in Nikon documentation somewhere. I always wondered why. 128.61.69.123 (talk) 22:56, 23 September 2008 (UTC)</p></blockquote>

<p>It would have died at this point if another Wikipedia editor hadn&rsquo;t gotten involved.</p>

<blockquote><p>Hmmm&hellip; very interesting. Do you have a reference for it anywhere??? ǝɹʎℲxoɯ (contrib) 06:33, 24 September 2008 (UTC)</p></blockquote>

<p>Well&hellip; One good lie begets another. Rob said:</p>

<blockquote><p>I&rsquo;m no longer working there, but I could possibly try to get some documents from people who still work there. 128.61.120.190 (talk) 09:32, 24 September 2008 (UTC)</p></blockquote>

<p>And then, a few days later, he said:</p>

<blockquote><p>So, after having asked around, I&rsquo;ve learned that the connector&rsquo;s internal name of &lsquo;Agox&rsquo; is on some documentation that we haven&rsquo;t released to the public yet. The name is perfectly fine to use for the article, but the Nikon documents cannot be released. If I could cite them here, I would, but alas, I am still bound not to release the information behind this. 24.98.65.137 (talk) 04:48, 30 September 2008 (UTC)</p></blockquote>

<p>Finally, about a month later, I came up with the most ridiculous thing I could imagine.</p>

<blockquote><p>It stands for Asynchronous Gamma-Object Transfer (x=trans). In Nikon&rsquo;s logical model, the alpha object acts as a server, the beta object acts as a client, and data that flows between the two are considered gamma objects. There are delta and epsilon objects as well, but those are too small to get into. 128.61.69.123 (talk) 23:27, 21 October 2008 (UTC)</p></blockquote>

<p>We left it at that. A few months later, Rob pointed me back at the main USB article. I scrolled through and saw this:</p>

<p><img src="http://i.imgur.com/usgXmpCl.png"></p>

<p>We&rsquo;d done it! Someone took our lies and made them reality! It didn&rsquo;t stop there. You could find Chinese companies selling AGOX cables and AGOX connectors, people mentioned AGOX connectors on forums, one guy even wrote a blog post about an AGOX to regular USB converter he made.</p>

<p>All good things must come to an end, and, rightly so, AGOX Connector got edited away. Wikipedia currently calls it a &ldquo;UC-E6 proprietary (non-USB) plug&rdquo;, but, in my heart of hearts, I know what it really is.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-09-19T10:23:41-05:00" pubdate data-updated="true">Sep 19<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/hack/'>hack,</a>, <a class='category' href='/blog/categories/history/'>history</a>, <a class='category' href='/blog/categories/prank/'>prank,</a>

</div>


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/09/15/telescope-update/">
		
			Telescope Update</a>
	</h2>
	<div class="entry-content">
		<p>I went to the <a href="http://sshchicago.org">Southside Hackerspace</a> this weekend to do some work on the telescope project. No major developments, but the following is worth pointing out:</p>

<h3>Driving a wood screw through Teflon is <strong>hard</strong>.</h3>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-09-15T07:53:44-05:00" pubdate data-updated="true">Sep 15<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/09/11/cancelling-comcast/">
		
			Cancelling Comcast</a>
	</h2>
	<div class="entry-content">
		<ul>
<li>Write down your account number.</li>
<li>Call Comcast: (1-800-934-6489)</li>
<li>Sit through the phone tree. The correct options are:

<ul>
<li>1: Yes, my phone number is the phone number associated with the account.</li>
<li>5: Remove services</li>
<li>3: Cancel all services</li>
<li>2: No, please don&rsquo;t call me later.</li>
</ul>
</li>
<li>Get confused when your phone makes the hanging up noise.</li>
</ul>


<p>Re-center your chakras and try again.</p>

<ul>
<li>Call Comcast.</li>
<li>1</li>
<li>5</li>
<li>3</li>
<li>2</li>
<li>A guy answers after less than a minute of waiting!

<ul>
<li>&ldquo;Hi, my name is Chris, and I&rsquo;d like to &ndash;&rdquo;</li>
<li>&ldquo;Hello, can you hear me? If you can hear me and I can&rsquo;t hear you, please call us back at&hellip;&rdquo;</li>
</ul>
</li>
</ul>


<p>Okay, maybe that was a fluke. Let&rsquo;s try again.</p>

<ul>
<li>Call Comcast.</li>
<li>1, 5, 3, 2</li>
<li>Another guy answers after a minute or two

<ul>
<li>I&rsquo;d like to cancel</li>
<li>I&rsquo;m moving, and Comcast doesn&rsquo;t service the new building</li>
<li>Okay, we&rsquo;ll go with &ldquo;the new building provides Comcast already&rdquo;</li>
<li>No, I don&rsquo;t want to add Comcast telephone service</li>
<li>Yes, I&rsquo;d like to cancel</li>
<li>I&rsquo;ll drop off the equipment</li>
<li>Okay, thank you!</li>
</ul>
</li>
</ul>


<p>It took ten minutes from start to finish.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-09-11T12:14:06-05:00" pubdate data-updated="true">Sep 11<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/08/29/celestron-firstscope/">
		
			Celestron FirstScope</a>
	</h2>
	<div class="entry-content">
		<p>I bought a Celestron FirstScope dobsinian telescope for a project that I&rsquo;ve been kicking around. It&rsquo;s not super duper, but for $50, it&rsquo;s a functional telescope.</p>

<p><a href="http://agocs.smugmug.com/Other/Misc/i-CjjQRdv/A" title="Photo & Video Sharing by SmugMug"><img src="http://agocs.smugmug.com/Other/Misc/i-CjjQRdv/0/L/20140829153602-L.jpg" title="Photo & Video Sharing by SmugMug" alt="Photo & Video Sharing by SmugMug"></a></p>

<p>Before I bought it, I was looking for some dimension specs. Unable to find any, I decided to document it myself.</p>

<p><a href="http://agocs.smugmug.com/Other/Misc/i-RwMDHNr/A" title="Photo & Video Sharing by SmugMug"><img src="http://agocs.smugmug.com/Other/Misc/i-RwMDHNr/0/M/20140829161147-M.jpg" title="Photo & Video Sharing by SmugMug" alt="Photo & Video Sharing by SmugMug"></a></p>

<p>Measurements are in inches, and are &ldquo;close enough&rdquo;</p>

<ul>
<li>Base diameter: 8&#8221;</li>
<li>Little rubber feet height: 1.25&#8221;</li>
<li>Lazy susan height: 1.25&#8221;</li>
<li>Floor to telescope tube mid-point: 9.5&#8221;</li>
<li>Telescope tube overall length: 10.5&#8221;</li>
<li>Telescope tube diameter: 4&#8221;</li>
<li>Eyepiece height (min): 2.5&#8221;</li>
<li>Eyepiece height (max): 4&#8221;</li>
</ul>


<h3>First Impressions</h3>

<p>It&rsquo;s not half bad. Pretty easy to use. Probably needs to be collimated, but it&rsquo;s definitely good enough for looking down on the city during the day. For $50, it&rsquo;s a solid scope. I&rsquo;m impressed.</p>

<p>Here&rsquo;s a picture I took of a barge. It&rsquo;s a pretty hazy day today, unfortunately.</p>

<p><a href="http://agocs.smugmug.com/Other/Misc/i-gmWWFq8/A" title="Photo & Video Sharing by SmugMug"><img src="http://agocs.smugmug.com/Other/Misc/i-gmWWFq8/0/L/20140829163122-L.jpg" title="Photo & Video Sharing by SmugMug" alt="Photo & Video Sharing by SmugMug"></a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-08-29T16:01:13-05:00" pubdate data-updated="true">Aug 29<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/hack/'>hack</a>, <a class='category' href='/blog/categories/telescope/'>telescope</a>

</div>


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/08/19/stupid-rabbitmq-tricks/">
		
			RabbitMQ Best Practices in Go</a>
	</h2>
	<div class="entry-content">
		<p>I decided to change the title of this article. Check out:</p>

<p><a href="http://agocs.org/blog/2014/08/19/rabbitmq-best-practices-in-go/">RabbitMQ Best Practices in Go</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-08-19T12:57:26-05:00" pubdate data-updated="true">Aug 19<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/rabbitmq/'>RabbitMQ</a>, <a class='category' href='/blog/categories/golang/'>golang</a>, <a class='category' href='/blog/categories/hack/'>hack</a>, <a class='category' href='/blog/categories/tips/'>tips</a>

</div>


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/08/19/rabbitmq-best-practices-in-go/">
		
			Tips for Using RabbitMQ in Go</a>
	</h2>
	<div class="entry-content">
		<h3>Corrections:</h3>

<ul>
<li>4% != .004% : When I was writing the article, my brain translated 99996 into 96000. Big difference. It turns out that I&rsquo;m unable to dequeue somewhere between .004% and .20% of messages in about half of test runs.</li>
</ul>


<h3>Note:</h3>

<p><strong>I&rsquo;ve been chatting with some very helpful RabbitMQ-knowledgeable people, and they have some suggestions for the issues I&rsquo;m seeing that I&rsquo;m going to check out. I will update this article with my findings.</strong></p>

<p>I want to thank <a href="https://twitter.com/old_sound">Alvaro Videla</a> and <a href="https://twitter.com/michaelklishin">Michael Klishin</a> for reading my first attempt at this post and suggesting different avenues to explore.</p>

<h2>Introduction</h2>

<p>For the two of you who don&rsquo;t know, RabbitMQ is a really neat AMQP-compliant queue broker. It exists to facilitate the passing of messages between or within systems. I&rsquo;ve used it for a couple of different projects, and I&rsquo;ve found it to be tremendously capable: I&rsquo;ve seen a RabbitMQ instance running on a single, moderately sized, VM handle almost 3GB/s.</p>

<p>I was doing some load testing with RabbitMQ recently, and I found that, if I started attempting to publish more than around 2500 10KB messages per second, <del>about 4%</del> as much as 0.2% of those messages wouldn&rsquo;t make it to the queue during some test runs. I am not sure if this is my code&rsquo;s fault or if I am running into the limits of the RabbitMQ instance I was testing against (probably the former), but with the help of the RabbitMQ community, I was able to come up with some best practices that I&rsquo;ve described below.</p>

<p>The examples below are all in Go, but I&rsquo;ve tried my best to explain them in such a way that people who are not familiar with Go can understand them.</p>

<h2>Terminology</h2>

<p>If you&rsquo;re unfamiliar with AMQP, here&rsquo;s some terminology to help understand what&rsquo;s possible with a queue broker and what the words mean.</p>

<ul>
<li><strong>Connection</strong>: A connection is a long-lived TCP connection between an AMQP client and a queue broker. Maintaining a connection reduces TCP overhead. A client can re-use a connection, and can share a connection among threads.</li>
<li><strong>Channel</strong>: A channel is a short-lived sub-connection between a client and a broker. The client can create and dispose of channels without incurring a lot of overhead.</li>
<li><strong>Exchange</strong>: A client writes messages to an exchange. The exchange forwards each message on to zero or more queues based on the message&rsquo;s routing key.</li>
<li><strong>Queue</strong>: A queue is a first-in, first out holder of messages. A client reads messages from a queue. The client can specify a queue name (useful, for example, for a work queue where multiple clients are consuming from the same queue), or allow the queue broker to assign it a queue name (useful if you want to distribute copies of a message to multiple clients).</li>
<li><strong>Routing Key</strong>: A string (optionally) attached to each message. Depending on the exchange type, the exchange may or may not use the Routing Key to determine the queues to which it should publish the message.</li>
<li><strong>Exchange types</strong>:

<ul>
<li><strong>Direct</strong>: Delivers all messages with the same routing key to the same queue(s).</li>
<li><strong>Fanout</strong>: Ignores the routing key, delivers a copy of the message to each queue bound to it.</li>
<li><strong>Topic</strong>: Each queue subscribes to a topic, which is a regular expression. The exchange delivers the message to a queue if the queue&rsquo;s subscribed topic matches the message.</li>
<li><strong>Header</strong>: Ignores the routing key and delivers the message based on the AMQP header. Useful for certain kinds of messages.</li>
</ul>
</li>
</ul>


<h2>Testing methodology</h2>

<p>Here is the load tester I wrote: <a href="https://github.com/backstop/rabbit-mq-stress-tester">https://github.com/backstop/rabbit-mq-stress-tester</a>. It uses the <a href="https://github.com/streadway/amqp">streadway/amqp library</a>. Per <a href="https://github.com/streadway/amqp/issues/93">this issue</a>, my stress tester does not share connections or channels between Goroutines &mdash; it launches a configurably-sized pool of Goroutines, each of which maintains its own connection to the RabbitMQ server.</p>

<p>To run the same tests I was running:</p>

<ul>
<li><p>Clone the repo or install using <code>go get github.com/backstop/rabbit-mq-stress-tester</code></p></li>
<li><p>Open two terminal windows. In one, run</p>

<pre><code>  ./tester -s test-rmq-server -c 100000
</code></pre></li>
</ul>


<p>That will launch the in Consumer mode. It defaults to 50 Goroutines, and will consume 100,000 messages before quitting.</p>

<ul>
<li><p>In the other terminal window, run</p>

<pre><code>  ./tester -s test-rmq-server -p 100000 -b 10000 -n 100 -q
</code></pre></li>
</ul>


<p>This will run the tester in Producer mode. It will (-p)roduce 100,000 messages of 10,000 (-b)ytes each. It will launch a pool of 100 Goroutines (-n), and it will work in (-q)uiet mode, only printing NACKs and final statistics to stdout.</p>

<p>What I found is that, roughly half the time I run the above steps, the consumer will only consume 99,000 and change messages (typically greater than 99,980, but occasionally as low as 99,800). I was unable to find any descriptive error messages in the <code>rabbitmq@test-rmq-server.log</code> file.</p>

<p>I can change that, though. If I run the producer like this:</p>

<pre><code>    ./tester -s test-rmq-server -p 100000 -b 10000 -n 100 -q -a
</code></pre>

<p>then each Goroutine waits for an ACK or NACK from the RabbitMQ server before publishing the next message (that&rsquo;s what the -a flag does). I have never seen a missing message in this mode. The functionality of the -a flag is described in the next section.</p>

<h3>Some things that I don&rsquo;t think are the culprit:</h3>

<ul>
<li>Memory-based flow control: Memory usage as reported by <code>top</code> never exceeds approximately 22%. Also, no messages in the log file.</li>
<li>Per-connection flow control: After fussing with <code>rabbitmqctl list_connections</code> for a while, I was not able to find evidence of a connection that had been blocked. I&rsquo;m not sure of these results, though, so if someone would be willing to give me a hand with this, that would be awesome.</li>
</ul>


<h2>Ensuring your message got published</h2>

<p>Like I said earlier, I was doing some stress testing against a RabbitMQ instance and a small number of messages that I attempted to publish did not get dequeued. I reached out to the RabbitMQ community, and someone on their IRC channel told me to look up Confirm Select.</p>

<p>When you place a channel into Confirm Select, the AMQP broker will respond with an ACK with a for each message passed to it on that channel. Included with the ACK is an integer that increments with each ACK, similar to a TCP sequence ID. If something goes wrong, the broker will respond with a NACK. In Go, placing a channel into Confirm Select looks like this:</p>

<figure class='code'><figcaption><span>Putting a channel in Confirm Select</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">channel</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">Channel</span><span class="p">()</span>
</span><span class='line'><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">println</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span class='line'>  <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">channel</span><span class="p">.</span><span class="nx">Confirm</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">ack</span><span class="p">,</span> <span class="nx">nack</span> <span class="o">:=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">NotifyConfirm</span><span class="p">(</span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">uint64</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">uint64</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above <code>channel.Confirm(false)</code> puts the channel into Confirm mode, and the <code>false</code> puts the client out of NoWait mode such that the client waits for an ACK or NACK after each message. <code>ack</code> and <code>nack</code> are golang <code>chan</code>s that receive the integers included with the ACKs or NACKs. If you were in NoWait mode, you could use them to bulk publish a bunch of messages and then figure out which messages did not make it.</p>

<p>Listening for the ACK looks like this:</p>

<figure class='code'><figcaption><span>Publish a message and wait for confirmation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'>   <span class="nx">channel</span><span class="p">.</span><span class="nx">Publish</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">q</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">amqp</span><span class="p">.</span><span class="nx">Publishing</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Headers</span><span class="p">:</span>         <span class="nx">amqp</span><span class="p">.</span><span class="nx">Table</span><span class="p">{},</span>
</span><span class='line'>      <span class="nx">ContentType</span><span class="p">:</span>     <span class="s">&quot;text/plain&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">ContentEncoding</span><span class="p">:</span> <span class="s">&quot;UTF-8&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Body</span><span class="p">:</span>            <span class="nx">messageJson</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">DeliveryMode</span><span class="p">:</span>    <span class="nx">amqp</span><span class="p">.</span><span class="nx">Transient</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Priority</span><span class="p">:</span>        <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">select</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nx">tag</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ack</span><span class="p">:</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Acked &quot;</span><span class="p">,</span> <span class="nx">tag</span><span class="p">)</span>
</span><span class='line'>  <span class="k">case</span> <span class="nx">tag</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">nack</span><span class="p">:</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Nack alert! &quot;</span><span class="p">,</span> <span class="nx">tag</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After each publish, I&rsquo;m performing a read off of the <code>ack</code> and <code>nack</code> chans (that is what <code>select</code> does). That read blocks until the client gets an ACK or NACK back from the broker.</p>

<p>The above examples are in Go, but there&rsquo;s an equivalent in the other libraries I&rsquo;ve played with. Clojure (langohr) has <code>confirm/select</code> and <code>confirm/wait-for-confirms-or-die</code>.</p>

<h3>Can we do better?</h3>

<p>Yes. Rather than wait for an ACK after each publish, it&rsquo;s better to publish a bunch of messages, listen for ACKs, and then handle failures. I didn&rsquo;t, because I was already seeing performance several orders of magnitude better than I needed.</p>

<p>We can also wrap blocks of messages in a transaction if we need to ensure that all messages get published and retain order, but doing that incurs something like a 250x performance penalty.</p>

<h2>Pool your Goroutines and avoid race conditions</h2>

<p><a href="https://github.com/streadway/amqp/issues/93">This issue</a> proved interesting (if ultimately not relevant to my problem). It looks like the person who filed the issue was running into two issues:</p>

<ul>
<li>There was a race condition in the code that counted ACKs / NACKs</li>
<li>The one-Goroutine-per-publish strategy causes a condition where the 2000 goroutines waiting for network IO prevent the goroutine listening for ACKs / NACKs from receiving sufficient CPU cycles.</li>
</ul>


<p>I got around this in two ways: I have a fixed-size pool of Goroutines performing the publishing, and each goroutine handles its own Publish &ndash;> Ack lifecycle.</p>

<h2>Ensuring messages get handled correctly</h2>

<p>A message queue is of little use if messages just sit there, so it is prudent to include a consumer or two. But, what happens if your consumer crashes? Does your message get lost in the ether?</p>

<p>The answer is <strong>AutoAck</strong>. More specifically, realizing that AutoAck is dangerous and wrong.</p>

<p>When a consumer consumes a message from a queue, the queue broker waits for an ACK before discarding the message. When a consumer has AutoAck enabled, it sends the ACK (thus causing the message to be discarded) instantly upon receiving the message. It&rsquo;s smarter to read the next message on the queue, handle the message properly, and then send the ACK.</p>

<figure class='code'><figcaption><span>Reading and acknowledging messages</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">autoAck</span> <span class="o">:=</span> <span class="kc">false</span>
</span><span class='line'>
</span><span class='line'><span class="nx">msgs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">Consume</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">autoAck</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="nx">d</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">msgs</span> <span class="p">{</span> <span class="c1">// the d stands for Delivery</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Body</span><span class="p">[:]))</span> <span class="c1">// or whatever you want to do with the message</span>
</span><span class='line'>  <span class="nx">d</span><span class="p">.</span><span class="nx">Ack</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the example above, <code>autoAck</code> is set to false. Every time I read a message (in the <code>for d := range msgs</code> loop), I send an ACK for that message. If I were to call <code>d.Ack(true)</code>, that would send an ACK for that message and all previous unacknowledged messages.</p>

<p>If my consumer quits without acknowledging a message, that message is repeated to the next consumer to come by.</p>

<h2>Performant results</h2>

<p>So, what kind of performance am I getting?</p>

<p>The following numbers are all time to publish and consume 100,000 messages, each with a 10KB payload. The tester was running on my Macbook, and RabbitMQ was running on a Cloudstack VM.</p>

<ul>
<li>With Confirm Select

<ul>
<li>Publishing: 24.42s</li>
<li>Consuming: 26.79s</li>
</ul>
</li>
<li>Without Confirm Select

<ul>
<li>Publishing: 16.32s</li>
<li>Consuming: 26.13s</li>
</ul>
</li>
</ul>


<p>The point is, RabbitMQ is fast and Go is fast. When we use one to stress test the other, messages get lost somewhere. If we take a little bit of time to ensure that messages get published and processed properly, we can prevent pesky data loss issues.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-08-19T12:57:26-05:00" pubdate data-updated="true">Aug 19<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/rabbitmq/'>RabbitMQ</a>, <a class='category' href='/blog/categories/golang/'>golang</a>, <a class='category' href='/blog/categories/hack/'>hack</a>, <a class='category' href='/blog/categories/tips/'>tips</a>

</div>


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/08/16/the-joke/">
		
			The Joke</a>
	</h2>
	<div class="entry-content">
		<p>Last night, I had a dream that I was telling a joke. It was a long one. I got almost all the way to the punchline before I woke up, and, thinking back on it, I had completely botched the setup. Shame on me.</p>

<p>Here&rsquo;s the joke:</p>

<p>In eastern Europe, some time in the 15th century, there was a young rabbi. He was just out of training and was not ready to settle down, so he was wandering the countryside performing good deeds.</p>

<p>One day in late spring, the rabbi came across a village situated at the base of a tall mountain. In Roman times, the village was called Villi de Trido, but the villagers just called it Trid and, each other, Trids. The rabbi stayed at the inn one night, and noticed that the Trids looked unusually malnourished and depressed. He took the innkeeper aside and inquired as to what was going on.</p>

<p>&ldquo;There is a rare and special fruit that only grows on the southern face of the mountain that towers above Trid. We Trids used to harvest the fruit. It nourshed us, and we would trade with neighboring villages, and Trid was prosperous! But last year, a monster inhabited the southern face of the mountain. When we go up to pick the delicate fruits, he kicks us off the mountain! Pow, just like that! Now we starve, and we cannot trade with the neighboring villages.&rdquo;</p>

<p>The rabbi could not let this go. He promised the innkeeper he would do something about it. Perhaps he could talk the monster into a deal with the villagers. He bought a stout rope, a pair of warm gloves, and borrowed some crampons to deal with ice. The next morning, he started up the mountain.</p>

<p>He climbed for hours, expecting to encounter the monster at every turn. The rabbi seemed brave, but he was honestly nervous. What do you say to a monster? He climbed higher and higher, dealing with more and more snow and ice, wishing he had borrowed a heavy coat. As the light faded and he was about to consider making camp for the night, he encountered the grove where the fruit grew! The trees were majestic, and he could see even now the first little fruits starting to bud.</p>

<p>He heard a noise behind him, and wheeled around to find the monster! It stood twelve feet tall, with shaggy black fur and massive paws the size of a man&rsquo;s face. Fearsome though it was, the monster didn&rsquo;t attack. The rabbi waited a moment, and then decided to speak. &ldquo;Monster! The people of the village below say that you kick them off of the mountain. Why is it you have not kicked <em>me</em> from the mountain?&rdquo;</p>

<p>The monster approached the rabbi, and extended one gigantic paw. Placing it on the man&rsquo;s shoulder, the monster said, &ldquo;Silly rabbi. Kicks are for Trids!&rdquo;</p>

<hr />

<p>In my dream, I made the mistake of calling the fruit &ldquo;Trids&rdquo; rather than the villagers. I&rsquo;m glad I woke up. That would have been <em>embarassing!</em></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-08-16T17:47:53-05:00" pubdate data-updated="true">Aug 16<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/06/26/arduino-workshop/">
		
			Arduino Workshop</a>
	</h2>
	<div class="entry-content">
		<p>Sometimes, shit doesn&rsquo;t work out. For example: Mike&rsquo;s Hard Lemonade contacted me at the <a href="http://sshchicago.org">Southside Hackerspace</a>, wanting us to modify a golf cart as part of their &ldquo;Mike&rsquo;s Hacks&rdquo; summer ad campaign. I dumped a lot of time (and just a little money) into the project, but everything went south at the last minute.</p>

<p>But this isn&rsquo;t about that.</p>

<p>At the same time, <a href="http://www.pinterest.com/r4v5/">Mason Donahue</a> put me in touch with <a href="https://www.facebook.com/ChicagoGirlsInComputing">Chicago Girls in Computing</a>. I put together a lesson plan, put together Arduino kits, made a powerpoint, and taught a class. It went awesome.</p>

<p>I had them assemble and program basic nightlights (LEDs turn on when the ambient light drops). They took that idea and ran with it.</p>

<p>The kits:</p>

<ul>
<li><a href="http://www.amazon.com/gp/product/B00761NDHI/ref=oh_details_o01_s00_i00?ie=UTF8&amp;psc=1">Sainsmart Nano V3</a> &mdash; $14</li>
<li><a href="https://www.adafruit.com/products/64">Half-size breadboard</a> &mdash; $5</li>
<li><a href="https://www.adafruit.com/products/161">Photoresistor</a> &mdash; $1</li>
<li>10Kohm resistor</li>
<li>9v battery</li>
<li>9v battery leads</li>
<li>bunches of LEDs</li>
</ul>


<p>The total cost per student came out to about $27. I was able to pick up a bunch of plastic containers from the grocery store for $0.10 each, and the kits fit into the containers.</p>

<iframe src="http://www.slideshare.net/slideshow/embed_code/36339800" width="476" height="400" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe>


<p>They seemed to like it.</p>

<p><a href="http://agocs.smugmug.com/Other/misc/29939745_7n8ptc#!i=3343759361&k=5fwQCB6&lb=1&s=A" title="Photo & Video Sharing by SmugMug"><img src="http://agocs.smugmug.com/Other/misc/i-5fwQCB6/0/L/20140621151638-L.jpg" title="Photo & Video Sharing by SmugMug" alt="Photo & Video Sharing by SmugMug"></a></p>

<p><a href="http://agocs.smugmug.com/Other/misc/29939745_7n8ptc#!i=3343759349&k=hKHRThm&lb=1&s=A" title="Photo & Video Sharing by SmugMug"><img src="http://agocs.smugmug.com/Other/misc/i-hKHRThm/0/L/20140621151700-L.jpg" title="Photo & Video Sharing by SmugMug" alt="Photo & Video Sharing by SmugMug"></a></p>

<p><a href="http://agocs.smugmug.com/Other/misc/29939745_7n8ptc#!i=3343759469&k=3W5HDLF&lb=1&s=A" title=""><img src="http://agocs.smugmug.com/Other/misc/i-3W5HDLF/0/L/20140621151538-L.jpg" title="" alt=""></a></p>

<p><a href="http://agocs.smugmug.com/Other/misc/29939745_7n8ptc#!i=3343759220&k=9WTNCvh&lb=1&s=A" title=""><img src="http://agocs.smugmug.com/Other/misc/i-9WTNCvh/0/L/20140621151415-L.jpg" title="" alt=""></a></p>

<p>Major props go to Backstop, Stack Overflow, and DigitalOcean. I wrote them at the last minute saying it would sure be neat if I could give out some stickers at the workshop. Backstop gave me pads and pens, Stack Overflow sent stickers and markers, and DigitalOcean sent me a bunch of stickers (and chocolates).</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-06-26T09:33:30-05:00" pubdate data-updated="true">Jun 26<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/04/24/robot-finds-kitten-as-a-service/">
		
			Robot Finds Kitten as a Service</a>
	</h2>
	<div class="entry-content">
		<p>I put together a webservice that serves 700 items that are not kittens.</p>

<p><a href="https://github.com/agocs/RobotFindsKittenServer">Github link</a></p>

<p><a href="http://agocs.org/robotfindskitten/non-kitten-item/">Watch it go</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-04-24T16:12:37-05:00" pubdate data-updated="true">Apr 24<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/04/15/migration/">
		
			Server Migration</a>
	</h2>
	<div class="entry-content">
		<p>I know my site doesn&rsquo;t exactly have any dedicated watchers, but if anyone noticed a period of downtime earlier this week, it&rsquo;s because I was migrating from hosting on FatCow to hosting on a rented VPS through DigitalOcean. I also moved my domain registration from FatCow to Gandi.net. In this post, I plan to cover the hows, whys, and some lessons learned.</p>

<p>I&rsquo;ll start with the juicy stuff.</p>

<h1>Why?</h1>

<p>There are a couple of reasons, but the root of it all is that I got fed up with FatCow. It&rsquo;s not clear how their pricing <strike>varies</strike> increases from year to year, and it&rsquo;s obnoxious how, every few months, I find myself signed up for another &ldquo;free trial&rdquo; of some service out of which I have to opt. I can roll my own solution for less money, and with greater control.</p>

<h2>Why move away from FatCow?</h2>

<p>Like I said above, money and annoyance. I have a few sites with FatCow, and the oldest is about to round the three year mark. When I signed up, I was offered a trial rate of around $30 for the first year. That&rsquo;s a very good deal. I barely used the site, but I ignored a few emails and, lo and behold, I found myself renewed automatically to the tune of $70-something. Okay, that&rsquo;s still not significantly more than $5/month. Pretty darn good for unlimited hosting, the fact that I&rsquo;m not using it notwithstanding. I turned off automatic renewal.</p>

<p>A few months ago, I got a message saying that FatCow couldn&rsquo;t automatically renew that site because the card information I had stored was bad. I logged in, turned automatic renewal off again, and looked at the invoice &mdash; they were about to bill me $200-something for April 2014-April 2015! No way! That&rsquo;s way too much.</p>

<p>I just renewed Agocs.org to the tune of $70-something with FatCow, but I decided it was in my best interests to break ties with that company completely, something I will be doing over the next few weeks.</p>

<h2>Why Gandi.net?</h2>

<p>Bluntly, they have a &ldquo;no bullshit&rdquo; policy. That, and they were recommended by a trusted coworker and friend, and they are a French corporation and French law meaningfully allows them to transfer ownership of &ldquo;Agocs.org&rdquo; over to me (most American registrars, I have been informed, retain ownership of the domain name and license its usage to you).</p>

<p>The process of getting things set up with Gandi.net was a little rocky, as I will detail below, but they have a bunch of good help text and an extensive knowledge base. I was able to get up and running quickly and with minimal bugging of my more knowledgeable friends.</p>

<h2>Why DigitalOcean?</h2>

<p>I&rsquo;ve hosted a few VPSs with DigitalOcean before, and they are a joy to work with. I get full control of a Linux box (something I never got from FatCow), I can choose my web server (Nginx all the way) and database back-end (none for me please!), and set it up however I want. Write a script that uses rsync to publish new articles? Sure! Go nuts! I fought with FatCow for a while about that, and resorted to using FTP (which, once you&rsquo;ve started using rsync, sucks).</p>

<p>Anyway, one small VPS costs me about five bones per month. Because I&rsquo;m just the tiniest bit clever, I can host several sites on the same VPS. They&rsquo;re all static content generated by Octopress, so it&rsquo;s not like I&rsquo;m going to outgrow the small server any time soon. It&rsquo;s <em>really</em> nice.</p>

<h1>How it worked</h1>

<p>The process was straightforward. I set up the VPS with DigitalOcean first, copied my site over there, installed Nginx, and got that configured. Then I requested a transfer code from FatCow (I suspect, but cannot confirm, that they drag their feet on this), and initiated the transfer through Gandi. The transfer cost me about $13, but that means Agocs.org is mine for an additional year. When the transfer was complete, I created a DNS Zone file through Gandi&rsquo;s web interface that points to my VPS.</p>

<h1>Lessons learned</h1>

<p>I made my fair share of mistakes, mostly in setting up the DNS Zonefile. My first attempt looked like this:</p>

<pre><code>* 10800 IN A 162.243.76.63
</code></pre>

<p>www.agocs.org worked great, but no email and no plain ol&#8217; agocs.org. Email was more critical, so around midnight that night I changed it to this:</p>

<pre><code>* 10800 IN A 162.243.76.63
imap 10800 IN CNAME access.mail.gandi.net.
pop 10800 IN CNAME access.mail.gandi.net.
smtp 10800 IN CNAME relay.mail.gandi.net.
@ 10800 IN MX 50 fb.mail.gandi.net.
@ 10800 IN MX 10 spool.mail.gandi.net.
</code></pre>

<p>The lines below were cribbed from Gandi.net&rsquo;s default Zone file. <a href="&#109;&#x61;&#x69;&#108;&#x74;&#x6f;&#x3a;&#99;&#x68;&#x72;&#105;&#115;&#x40;&#97;&#x67;&#111;&#x63;&#x73;&#46;&#x6f;&#x72;&#103;">&#99;&#x68;&#114;&#105;&#x73;&#64;&#97;&#103;&#x6f;&#x63;&#115;&#46;&#x6f;&#x72;&#x67;</a> worked, but agocs.org did not. I did some research and then made the following change:</p>

<pre><code>* 10800 IN A 162.243.76.63
@ 10800 IN A 162.243.76.63
imap 10800 IN CNAME access.mail.gandi.net.
pop 10800 IN CNAME access.mail.gandi.net.
smtp 10800 IN CNAME relay.mail.gandi.net.
@ 10800 IN MX 50 fb.mail.gandi.net.
@ 10800 IN MX 10 spool.mail.gandi.net.
</code></pre>

<p>I found out the * record points all _sub_domains to that IP address, but it does not point the root domain (i.e. agocs.org) there. The @ record points the root domain to that IP address.</p>

<p>Finally, I noticed a problem with sent email. The last change I had to make was through Gmail, which was sending agocs.org traffic through an SMTP server run by FatCow. I&rsquo;m way too lazy to roll my own SMTP server, so I told Gmail to take care of it.</p>

<p>There you have it.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-04-15T16:53:19-05:00" pubdate data-updated="true">Apr 15<span>th</span>, 2014</time></div>
	


	
</div></article>

<nav id="pagenavi">
    
        <a href="/" class="prev">Prev</a>
    
    
        <a href="/blog/page/3/" class="next">Next</a>
    
    <div class="center"><a href="/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Christopher Agocs

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'agocs';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
